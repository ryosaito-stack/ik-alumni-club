rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 管理者かどうかを判定する関数
    function isAdmin() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/members/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role == 'admin';
    }
    
    // アクティブなユーザーかどうかを判定する関数
    function isActiveUser() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/members/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/members/$(request.auth.uid)).data.isActive == true;
    }
    
    // 会員情報
    match /members/{uid} {
      // 読み取り：本人または管理者
      allow read: if request.auth != null && 
        (request.auth.uid == uid || isAdmin());
      
      // 作成：本人のみ
      allow create: if request.auth != null && request.auth.uid == uid;
      
      // 更新：本人のみ（ただしrole、plan、isActiveの変更は管理者のみ）
      allow update: if request.auth != null && 
        ((request.auth.uid == uid && 
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'plan', 'isActive'])) ||
        isAdmin());
      
      // 削除：管理者のみ
      allow delete: if isAdmin();
      
      // リスト取得：管理者のみ
      allow list: if isAdmin();
    }
    
    // コンテンツ
    match /contents/{id} {
      // 読み取り：アクティブなユーザーのみ
      allow read: if isActiveUser();
      
      // 書き込み：管理者のみ
      allow write: if isAdmin();
    }
    
    // インフォメーション（お知らせ）
    match /informations/{id} {
      // 公開済みかどうかを判定
      function isPublished() {
        return resource.data.published == true;
      }
      
      // 読み取り：公開済みのみ（全ユーザーアクセス可能）
      allow read: if isPublished();
      
      // リスト取得：全て（クライアント側でpublished=trueをフィルタリング）
      allow list: if true;
      
      // 書き込み（作成・更新・削除）：管理者のみ
      allow write: if isAdmin();
    }
    
    // スケジュール（イベント）
    match /schedules/{id} {
      // 公開済みかどうかを判定
      function isPublished() {
        return resource.data.published == true;
      }
      
      // 読み取り：公開済みのみ（全員アクセス可能）
      allow read: if isPublished();
      
      // リスト取得：全て（クライアント側でpublished=trueをフィルタリング）
      allow list: if true;
      
      // 書き込み（作成・更新・削除）：管理者のみ
      allow write: if isAdmin();
    }

    // 動画コンテンツ
    match /videos/{id} {
      // 公開済みかどうかを判定
      function isPublished() {
        return resource.data.published == true;
      }
      
      // 読み取り：公開済みのみ（全員アクセス可能）
      allow read: if isPublished();
      
      // リスト取得：全て（クライアント側でpublished=trueをフィルタリング）
      allow list: if true;
      
      // 書き込み（作成・更新・削除）：管理者のみ
      allow write: if isAdmin();
    }
    
    // ブログ記事
    match /blogs/{id} {
      // 公開済みかどうかを判定
      function isPublished() {
        return resource.data.published == true;
      }
      
      // 読み取り：公開済みのみ（全員アクセス可能）
      allow read: if isPublished();
      
      // リスト取得：全て（クライアント側でpublished=trueをフィルタリング）
      allow list: if true;
      
      // 書き込み（作成・更新・削除）：管理者のみ
      allow write: if isAdmin();
    }
  }
}