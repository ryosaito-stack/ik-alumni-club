# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ğŸ“Š ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ **ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰è¨­è¨ˆï¼ˆ3å±¤æ§‹é€ ï¼‰** ã‚’æ¡ç”¨ã—ã€å…±é€šåŸºç›¤ã‚¯ãƒ©ã‚¹ã«ã‚ˆã‚‹é«˜åº¦ãªæŠ½è±¡åŒ–ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Presentation Layer             â”‚
â”‚         (Pages / Components)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Hooks Layer                   â”‚
â”‚    (BaseUserHooks/BaseAdminHooks)       â”‚
â”‚         â†“ ç¶™æ‰¿ãƒ»åˆ©ç”¨ â†“                  â”‚
â”‚    (Custom Hooks / Cache Management)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Firestore Layer                 â”‚
â”‚         (BaseRepository)                â”‚
â”‚         â†“ ç¶™æ‰¿ãƒ»åˆ©ç”¨ â†“                  â”‚
â”‚    (Data Access / CRUD Operations)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Types Layer                   â”‚
â”‚      (Type Definitions / Models)        â”‚
â”‚         (Common Author Type)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ ä¸»è¦ãªè¨­è¨ˆåŸå‰‡

1. **DRY (Don't Repeat Yourself)**: å…±é€šåŸºç›¤ã‚¯ãƒ©ã‚¹ã§é‡è¤‡ã‚’å¾¹åº•æ’é™¤
2. **å˜ä¸€è²¬ä»»åŸå‰‡**: å„å±¤ãƒ»å„ã‚¯ãƒ©ã‚¹ãŒæ˜ç¢ºãªè²¬å‹™ã‚’æŒã¤
3. **ä¾å­˜æ€§é€†è»¢**: æŠ½è±¡ã«ä¾å­˜ã—ã€å…·è±¡ã«ä¾å­˜ã—ãªã„
4. **å‹å®‰å…¨æ€§**: TypeScriptã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã§å®Œå…¨ãªå‹ã‚µãƒãƒ¼ãƒˆ

## 1ï¸âƒ£ Typeså±¤ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å®šç¾©ï¼‰

### å…±é€šå‹å®šç¾©
```typescript
// /src/types/author.ts
export interface Author {
  id: string;
  name: string;
  role: string;
}
```

### æ©Ÿèƒ½åˆ¥å‹å®šç¾©
```typescript
// /src/types/[feature].ts
export interface [Feature] {
  id: string;
  // ... æ©Ÿèƒ½å›ºæœ‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  author?: Author;        // ä½œæˆè€…æƒ…å ±ï¼ˆå…±é€šå‹ã‚’ä½¿ç”¨ï¼‰
  published: boolean;      // å…¬é–‹çŠ¶æ…‹
  createdAt: Date;
  updatedAt: Date;
}

export interface [Feature]FormData {
  // ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®å‹ï¼ˆid, createdAtç­‰ã‚’é™¤å¤–ï¼‰
}

export interface [Feature]QueryOptions {
  published?: boolean;
  limit?: number;
  orderBy?: string;
  orderDirection?: 'asc' | 'desc';
}
```

## 2ï¸âƒ£ Firestoreå±¤ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ï¼‰

### å…±é€šåŸºç›¤ï¼šBaseRepository

```typescript
// /src/lib/firestore/base-repository.ts
export class BaseRepository<T> {
  constructor(
    private collectionName: string,
    private converter: (id: string, data: DocumentData) => T
  ) {}

  async getAll(): Promise<T[]> {
    const snapshot = await getDocs(collection(db, this.collectionName));
    return snapshot.docs.map(doc => 
      this.converter(doc.id, doc.data())
    );
  }

  async getById(id: string): Promise<T | null> {
    const docRef = doc(db, this.collectionName, id);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      return this.converter(docSnap.id, docSnap.data());
    }
    return null;
  }
}
```

### æ©Ÿèƒ½åˆ¥å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

```
/src/lib/firestore/[feature]/
â”œâ”€â”€ constants.ts    # å®šæ•°ãƒ»å…±é€šã‚¤ãƒ³ãƒãƒ¼ãƒˆ
â”œâ”€â”€ converter.ts    # å‹å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ base.ts        # BaseRepositoryåˆ©ç”¨ã®åŸºæœ¬æ“ä½œ
â”œâ”€â”€ filters.ts     # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆåˆ†é›¢æ¨å¥¨ï¼‰
â”œâ”€â”€ user.ts        # ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ï¼ˆå…¬é–‹ã®ã¿ï¼‰
â””â”€â”€ admin.ts       # ç®¡ç†è€…ç”¨ï¼ˆCRUDæ“ä½œï¼‰
```

#### base.ts ã®å®Ÿè£…ä¾‹
```typescript
import { BaseRepository } from '@/lib/firestore/base-repository';
import { COLLECTION_NAME, convertToSchedule } from './constants';

// BaseRepositoryã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ï¼ˆãŸã£ãŸ3è¡Œï¼ï¼‰
const repository = new BaseRepository<Schedule>(
  COLLECTION_NAME,
  convertToSchedule
);

export const getSchedules = () => repository.getAll();
export const getScheduleById = (id: string) => repository.getById(id);
```

## 3ï¸âƒ£ Hookså±¤ï¼ˆçŠ¶æ…‹ç®¡ç†ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰

### å…±é€šåŸºç›¤ã‚¯ãƒ©ã‚¹

#### BaseUserHooksï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰
```typescript
// /src/hooks/common/BaseUserHooks.ts
export class BaseUserHooks<T, QueryOptions> {
  private listCache;
  private singleCache;
  
  constructor(config: {
    getList: (options?: QueryOptions) => Promise<T[]>;
    getById: (id: string) => Promise<T | null>;
    getCacheKey: (options?: QueryOptions) => string;
    cachePrefix: string;
  }) {
    // MemoryCacheã‚’ä½¿ç”¨ã—ãŸçµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
    this.listCache = getGlobalCache<T[]>(`${config.cachePrefix}_list`);
    this.singleCache = getGlobalCache<T>(`${config.cachePrefix}_single`);
  }

  useList = (options?: QueryOptions) => {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’è‡ªå‹•åŒ–
    // ã‚ãšã‹æ•°è¡Œã§å®Œå…¨ãªçŠ¶æ…‹ç®¡ç†ã‚’å®Ÿç¾
  }

  useDetail = (id: string | null) => {
    // è©³ç´°å–å¾—ã‚‚åŒæ§˜ã«ç°¡æ½”ã«å®Ÿè£…
  }
}
```

#### BaseAdminHooksï¼ˆç®¡ç†è€…å‘ã‘ï¼‰
```typescript
// /src/hooks/common/BaseAdminHooks.ts
export class BaseAdminHooks<T, FormData, QueryOptions> {
  // BaseUserHooksã¨åŒæ§˜ã®æ§‹é€ 
  // + CRUDæ“ä½œã®ã‚µãƒãƒ¼ãƒˆ
  
  useMutations = () => {
    return {
      create: async (data: FormData, author?: Author) => { ... },
      update: async (id: string, data: FormData) => { ... },
      delete: async (id: string) => { ... },
      loading,
      error,
    };
  }
}
```

### å®Ÿè£…ä¾‹ï¼ˆé©šãã»ã©ã‚·ãƒ³ãƒ—ãƒ«ï¼ï¼‰

```typescript
// /src/hooks/schedules/user.ts
const schedulesHooks = new BaseUserHooks<Schedule, ScheduleQueryOptions>({
  getList: schedulesApi.getPublishedSchedules,
  getById: schedulesApi.getSchedule,
  getCacheKey: (options) => JSON.stringify(options || {}),
  cachePrefix: 'schedules_user',
});

// ãŸã£ãŸ1è¡Œã§ãƒ•ãƒ«æ©Ÿèƒ½ã®ãƒ•ãƒƒã‚¯ã‚’ä½œæˆï¼
export const useSchedulesList = (options = {}) => {
  const { items: schedules, loading, error, refresh } = schedulesHooks.useList(options);
  return { schedules, loading, error, refresh };
};
```

## ğŸš€ çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ 

### MemoryCache ã‚¯ãƒ©ã‚¹
```typescript
// /src/lib/cache.ts
export class MemoryCache<T> {
  private cache = new Map<string, CacheEntry<T>>();
  
  // æ©Ÿèƒ½ï¼š
  // - TTLï¼ˆTime To Liveï¼‰ç®¡ç†
  // - LRUï¼ˆLeast Recently Usedï¼‰ã‚¨ãƒ“ã‚¯ã‚·ãƒ§ãƒ³
  // - ãƒ’ãƒƒãƒˆç‡çµ±è¨ˆ
  // - ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
  
  get(key: string): T | null { ... }
  set(key: string, data: T): void { ... }
  clear(): void { ... }
  debug(): void { ... }  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ…‹ã®å¯è¦–åŒ–
  getInfo(): CacheInfo { ... }  // çµ±è¨ˆæƒ…å ±å–å¾—
}
```

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
```typescript
// åå‰ä»˜ãã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å–å¾—
const cache = getGlobalCache<T>('cache_name', TTL, maxSize);

// å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
debugAllGlobalCaches();

// å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢
clearAllGlobalCaches();
```

## ğŸ“Š å®Ÿè£…æˆæœï¼ˆã‚³ãƒ¼ãƒ‰å‰Šæ¸›ç‡ï¼‰

### å…±é€šåŸºç›¤å°å…¥ã«ã‚ˆã‚‹åŠ¹æœ

| æ©Ÿèƒ½ | å…ƒã®ã‚³ãƒ¼ãƒ‰è¡Œæ•° | ãƒªãƒ•ã‚¡ã‚¯ã‚¿å¾Œ | å‰Šæ¸›ç‡ |
|------|-------------|-----------|--------|
| informations admin hooks | 227è¡Œ | 59è¡Œ | **74%å‰Šæ¸›** |
| schedules admin hooks | 161è¡Œ | 49è¡Œ | **70%å‰Šæ¸›** |
| informations user hooks | 130è¡Œ | 44è¡Œ | **66%å‰Šæ¸›** |
| schedules user hooks | 154è¡Œ | 51è¡Œ | **67%å‰Šæ¸›** |
| **åˆè¨ˆ** | **672è¡Œ** | **203è¡Œ** | **70%å‰Šæ¸›** |

### ãƒ¡ãƒªãƒƒãƒˆ
- **ä¿å®ˆæ€§**: ãƒã‚°ä¿®æ­£ãƒ»æ©Ÿèƒ½è¿½åŠ ãŒ1ç®‡æ‰€ã§å®Œçµ
- **ä¸€è²«æ€§**: å…¨æ©Ÿèƒ½ãŒåŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å‹•ä½œ
- **æ‹¡å¼µæ€§**: æ–°æ©Ÿèƒ½è¿½åŠ ãŒæ•°åˆ†ã§å®Œäº†
- **å‹å®‰å…¨**: ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã«ã‚ˆã‚‹å®Œå…¨ãªå‹ã‚µãƒãƒ¼ãƒˆ
- **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**: ãƒ­ã‚¸ãƒƒã‚¯ãŒåˆ†é›¢ã•ã‚Œå˜ä½“ãƒ†ã‚¹ãƒˆå®¹æ˜“

## ğŸ”§ æ–°æ©Ÿèƒ½è¿½åŠ ã‚¬ã‚¤ãƒ‰ï¼ˆè¶…é«˜é€Ÿå®Ÿè£…ï¼‰

### æ–°ã—ã„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’10åˆ†ã§å®Ÿè£…ã™ã‚‹æ–¹æ³•

#### 1. Typeså®šç¾©ï¼ˆ2åˆ†ï¼‰
```typescript
// /src/types/video.ts
export interface Video {
  id: string;
  title: string;
  url: string;
  author: Author;  // å…±é€šå‹ã‚’ä½¿ç”¨
  published: boolean;
  // ...
}
```

#### 2. Firestoreå±¤ï¼ˆ3åˆ†ï¼‰
```typescript
// /src/lib/firestore/videos/base.ts
const repository = new BaseRepository<Video>(
  'videos',
  convertToVideo
);

export const getVideos = () => repository.getAll();
export const getVideoById = (id) => repository.getById(id);
```

#### 3. Hookså±¤ï¼ˆ3åˆ†ï¼‰
```typescript
// /src/hooks/videos/user.ts
const videosHooks = new BaseUserHooks<Video, VideoQueryOptions>({
  getList: videosApi.getPublishedVideos,
  getById: videosApi.getVideo,
  getCacheKey: (options) => JSON.stringify(options || {}),
  cachePrefix: 'videos_user',
});

export const useVideosList = (options = {}) => {
  const { items: videos, loading, error, refresh } = videosHooks.useList(options);
  return { videos, loading, error, refresh };
};
```

#### 4. å®Œæˆï¼ï¼ˆæ®‹ã‚Š2åˆ†ã§ãƒ†ã‚¹ãƒˆï¼‰

## ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹ç¢ºèª
```typescript
// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
import { debugAllGlobalCaches } from '@/lib/cache';
debugAllGlobalCaches();

// å‡ºåŠ›ä¾‹ï¼š
// Cache: schedules_user_list
// Size: 5, Hit Rate: 85.2%, TTL: 300s
// Cache: informations_admin_single
// Size: 12, Hit Rate: 92.1%, TTL: 300s
```

### ç‰¹å®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢
```typescript
import { getGlobalCache } from '@/lib/cache';
const cache = getGlobalCache('schedules_user_list');
cache.clear();
```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

1. **æ¨©é™åˆ†é›¢ã®å¾¹åº•**
   - user/adminãƒ•ãƒƒã‚¯ã®ç‰©ç†çš„åˆ†é›¢
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ç‹¬ç«‹ï¼ˆãƒ‡ãƒ¼ã‚¿æ¼æ´©é˜²æ­¢ï¼‰

2. **å…¬é–‹åˆ¶å¾¡**
   - `published`ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹ä¸€å…ƒç®¡ç†
   - `filterPublished`ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®å¼·åˆ¶ä½¿ç”¨

3. **Authoræƒ…å ±ã®ä¿è­·**
   - ä½œæˆè€…æƒ…å ±ã¯ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘APIã§ã¯Authoræƒ…å ±ã‚’é™¤å¤–

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
```
1. ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªï¼ˆæœ€é€Ÿ: <1msï¼‰
   â†“ ãƒ’ãƒƒãƒˆã—ãªã„å ´åˆ
2. å˜ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªï¼ˆé«˜é€Ÿ: <5msï¼‰
   â†“ ãƒ’ãƒƒãƒˆã—ãªã„å ´åˆ
3. Firestore APIå‘¼ã³å‡ºã—ï¼ˆé€šå¸¸: 50-200msï¼‰
   â†“ å–å¾—å¾Œ
4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆTTL: 5åˆ†ï¼‰
```

### çµ±è¨ˆæƒ…å ±ã®æ´»ç”¨
```typescript
const cache = getGlobalCache('schedules_user_list');
const info = cache.getInfo();
console.log(`ãƒ’ãƒƒãƒˆç‡: ${(info.stats.hitRate * 100).toFixed(1)}%`);
// ãƒ’ãƒƒãƒˆç‡ãŒä½ã„å ´åˆã¯TTLã®èª¿æ•´ã‚’æ¤œè¨
```

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Firebaseè¨­å®šã‚¬ã‚¤ãƒ‰](./setup-guide.md)
- [ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„](./.cursor/rules/coding-standards.md)
- [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](../CLAUDE.md)

---

## ğŸ“ æ›´æ–°å±¥æ­´

- **2025-09-20 v2.0**: 
  - BaseUserHooks/BaseAdminHookså°å…¥ã«ã‚ˆã‚‹å¤§è¦æ¨¡ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
  - çµ±ä¸€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆMemoryCacheï¼‰ã®å®Œå…¨çµ±åˆ
  - ã‚³ãƒ¼ãƒ‰å‰Šæ¸›ç‡70%é”æˆ
  - å…±é€šAuthorå‹ã®å°å…¥
  
- **2025-09-20 v1.1**: 
  - BaseRepositoryã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
  - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢

- **2025-09-20 v1.0**: 
  - åˆç‰ˆä½œæˆ

æœ€çµ‚æ›´æ–°: 2025-09-20